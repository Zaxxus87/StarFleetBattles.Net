@page "/"
@using StarFleetBattles.Application.DTOs
@using StarFleetBattles.Application.Services
@using Microsoft.AspNetCore.Components.Web
@using StarFleetBattles.Web.Components.Shared
@inject IGameService GameService
@inject IEnergyAllocationService EnergyService
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

<PageTitle>Star Fleet Battles</PageTitle>

<div tabindex="0" @onkeydown="HandleKeyDown" @onfocus="OnFocused" 
     style="outline: none; width: 100%; height: 100vh;">

<div style="display: flex; gap: 20px; padding: 20px; height: calc(100vh - 40px); overflow: hidden;">
    <!-- Left Panel: Game Controls and Hex Grid -->
    <div style="display: flex; flex-direction: column; overflow: hidden;">
        <div style="background: white; border: 2px solid #333; padding: 10px; margin-bottom: 10px;">
            <h1 style="margin: 0;">Star Fleet Battles</h1>
        </div>
        
        <div style="background: white; border: 2px solid #333; padding: 10px; margin-bottom: 10px;">
            <div style="display: inline-block; background-color: #f0f0f0; padding: 10px 20px; border-radius: 5px; margin-right: 20px; border: 2px solid #007bff;">
                <strong style="font-size: 18px;">Turn: @currentTurn</strong>
            </div>
            <button class="btn btn-primary" @onclick="MoveNormal" disabled="@isProcessing">
                ↑ Move Forward
            </button>
            <button class="btn btn-secondary" @onclick="SideslipLeft" disabled="@isProcessing">
                ← Left
            </button>
            <button class="btn btn-secondary" @onclick="SideslipRight" disabled="@isProcessing">
                → Right
            </button>
            <button class="btn btn-info" @onclick="TurnLeft" disabled="@isProcessing">
                ↺ Turn Left
            </button>
            <button class="btn btn-info" @onclick="TurnRight" disabled="@isProcessing">
                ↻ Turn Right
            </button>
            <button class="btn btn-danger" @onclick="EndTurn">
                ⏭ End Turn
            </button>
        </div>

        <div style="flex: 1; border: 2px solid #ddd; background: white; overflow: auto; max-width: fit-content;">
            <svg width="800" height="900" viewBox="0 0 800 900">
                @{
                    var hexSize = 30;
                    var hexWidth = hexSize * 2;
                    var hexHeight = hexSize * Math.Sqrt(3);
                    var colWidth = hexWidth * 0.75;
                    var rowHeight = hexHeight;
                }
                
                @for (int row = 0; row < 15; row++)
                {
                    @for (int col = 0; col < 20; col++)
                    {
                        var centerX = 50 + col * colWidth;
                        var centerY = 50 + row * rowHeight;
                        
                        if (col % 2 == 1)
                        {
                            centerY += rowHeight / 2;
                        }
                        
                        <polygon points="@GetHexagonPoints(centerX, centerY, hexSize)" 
                                 fill="none" 
                                 stroke="black" 
                                 stroke-width="1" />
                    }
                }

                @if (playerShip != null)
                {
                    <image x="@(playerShip.X - 20)" y="@(playerShip.Y - 20)"
                           width="40" height="40"
                           href="@GetShipImagePath(playerShip.Facing)"
                           opacity="1" />

                    <circle cx="@playerShip.X" cy="@playerShip.Y" r="1" fill="red" />
                }
            </svg>
        </div>
    </div>
        <!-- Right Panel: Energy Allocation Form or Ship Status Display -->
        <div style="flex: 1; display: flex; flex-direction: column; overflow: hidden; border: 2px solid #007bff; border-radius: 8px; background: white;">
            <div style="padding: 15px; border-bottom: 2px solid #007bff; background-color: #f8f9fa;">
                <h3 style="margin: 0; color: #007bff;">
                    @if (showShipStatus)
                    {
                        <span>Ship Status Display</span>
                    }
                    else
                    {
                        <span>Energy Allocation - Turn @currentTurn</span>
                    }
                </h3>
            </div>

            <div style="flex: 1; overflow: auto; padding: 15px;">
                @if (showShipStatus)
                {
                    <ShipStatusDisplay OnBackToEnergy="@(() => showShipStatus = false)" />
                }
                else
                {
                    <EnergyAllocationForm CurrentTurn="@currentTurn" OnShowShip="@(() => showShipStatus = true)" />
                }
            </div>
        </div>
</div>
</div>

@code {
    private ShipDto? playerShip;
    private bool isProcessing = false;
    private string debugMessage = "";
    private bool hasFocus = false;
    private int currentTurn = 1;
    private bool showShipStatus = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            debugMessage = "Initializing...";
            await GameService.InitializeGameAsync();
            await RefreshGameState();
            currentTurn = EnergyService.GetCurrentTurn();
            debugMessage = "Ready!";
        }
        catch (Exception ex)
        {
            debugMessage = $"Error: {ex.Message}";
        }
    }

    private void EndTurn()
    {
        try
        {
            if (!EnergyService.ValidateTurn(currentTurn, out var error))
            {
                debugMessage = $"Cannot end turn: {error}";
                return;
            }

            EnergyService.AdvanceTurn();
            currentTurn = EnergyService.GetCurrentTurn();
            debugMessage = $"Advanced to Turn {currentTurn}";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            debugMessage = $"Error ending turn: {ex.Message}";
        }
    }

    private async Task OnFocused()
    {
        hasFocus = true;
        debugMessage = "Click here first, then use keyboard: ↑ = Move, ← → = Sideslip, R = Turn Right, E = Turn Left";
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (isProcessing) return;

        switch (e.Key.ToLower())
        {
            case "arrowup":
                await MoveNormal();
                break;
            case "arrowleft":
                await SideslipLeft();
                break;
            case "arrowright":
                await SideslipRight();
                break;
            case "r":
                await TurnRight();
                break;
            case "e":
                await TurnLeft();
                break;
            case "escape":
                debugMessage = "Game focused. Use keyboard controls.";
                break;
        }
    }

    private string GetHexagonPoints(double centerX, double centerY, double radius)
    {
        var points = new List<string>();
        for (int i = 0; i < 6; i++)
        {
            var angle = (i * 60) * Math.PI / 180;
            var x = centerX + radius * Math.Cos(angle);
            var y = centerY + radius * Math.Sin(angle);
            points.Add($"{x:F1},{y:F1}");
        }
        return string.Join(" ", points);
    }

    private string GetShipImagePath(int facing)
    {
        return $"/images/federation{facing + 1}.jpg";
    }

    private string GetFacingDirection(int facing)
    {
        return facing switch
        {
            0 => "North",
            1 => "Northeast",
            2 => "Southeast", 
            3 => "South",
            4 => "Southwest",
            5 => "Northwest",
            _ => "Unknown"
        };
    }

    private async Task MoveNormal()
    {
        if (isProcessing) return;
        isProcessing = true;
        try
        {
            await GameService.MovePlayerShipNormalAsync();
            await RefreshGameState();
            debugMessage = "Moved forward!";
        }
        catch (Exception ex) { debugMessage = $"Move error: {ex.Message}"; }
        finally { isProcessing = false; }
    }

    private async Task SideslipRight()
    {
        if (isProcessing) return;
        isProcessing = true;
        try
        {
            await GameService.SideslipPlayerShipRightAsync();
            await RefreshGameState();
            debugMessage = "Sideslipped right!";
        }
        catch (Exception ex) { debugMessage = $"Right error: {ex.Message}"; }
        finally { isProcessing = false; }
    }

    private async Task SideslipLeft()
    {
        if (isProcessing) return;
        isProcessing = true;
        try
        {
            await GameService.SideslipPlayerShipLeftAsync();
            await RefreshGameState();
            debugMessage = "Sideslipped left!";
        }
        catch (Exception ex) { debugMessage = $"Left error: {ex.Message}"; }
        finally { isProcessing = false; }
    }

    private async Task TurnRight()
    {
        if (isProcessing) return;
        isProcessing = true;
        try
        {
            await GameService.TurnPlayerShipRightAsync();
            await RefreshGameState();
            debugMessage = "Turned right!";
        }
        catch (Exception ex) { debugMessage = $"Turn right error: {ex.Message}"; }
        finally { isProcessing = false; }
    }

    private async Task TurnLeft()
    {
        if (isProcessing) return;
        isProcessing = true;
        try
        {
            await GameService.TurnPlayerShipLeftAsync();
            await RefreshGameState();
            debugMessage = "Turned left!";
        }
        catch (Exception ex) { debugMessage = $"Turn left error: {ex.Message}"; }
        finally { isProcessing = false; }
    }

    private async Task RefreshGameState()
    {
        try
        {
            playerShip = await GameService.GetPlayerShipAsync();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            debugMessage = $"Refresh error: {ex.Message}";
        }
    }
}

<style>
    .btn {
        padding: 8px 12px;
        margin: 3px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
    }
    .btn-primary { background-color: #007bff; color: white; }
    .btn-secondary { background-color: #6c757d; color: white; }
    .btn-info { background-color: #17a2b8; color: white; }
    .btn-success { background-color: #28a745; color: white; }
    .btn-danger { background-color: #dc3545; color: white; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
</style>